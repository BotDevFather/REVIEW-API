<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Testimonial Grid - Community Gallery</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Custom styles for masonry grid */
        .masonry-grid {
            column-count: 4;
            column-gap: 1rem;
        }
        
        @media (max-width: 1280px) {
            .masonry-grid {
                column-count: 3;
            }
        }
        
        @media (max-width: 1024px) {
            .masonry-grid {
                column-count: 2;
            }
        }
        
        @media (max-width: 640px) {
            .masonry-grid {
                column-count: 1;
            }
        }
        
        .masonry-item {
            break-inside: avoid;
            margin-bottom: 1rem;
            position: relative;
        }
        
        /* Animation styles */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        .card-hover {
            transition: transform 0.3s ease-in-out;
        }
        
        .card-hover:hover {
            transform: scale(1.05);
        }
        
        /* Edit pencil icon */
        .edit-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .masonry-item:hover .edit-icon {
            opacity: 1;
        }
        
        .edit-icon:hover {
            background: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div class="w-full min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-12">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">Community Gallery</h1>
                <p class="text-gray-600">Join <span id="totalReviews" class="font-semibold text-blue-600">2</span> others who shared their experiences</p>
            </div>
            
            <!-- Masonry Grid -->
            <div class="masonry-grid" id="masonry-grid">
                <!-- Loading indicator -->
                <div id="loadingIndicator" class="col-span-full text-center py-8">
                    <div class="inline-block">
                        <div class="spinner" style="border-top-color: #3b82f6;"></div>
                        <p class="mt-2 text-gray-600">Loading reviews...</p>
                    </div>
                </div>
            </div>
            
            <!-- Load More Button -->
            <div id="loadMoreContainer" class="mt-8 text-center hidden">
                <button
                    id="loadMoreBtn"
                    onclick="loadMoreReviews()"
                    class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1 shadow-lg hover:shadow-xl flex items-center justify-center mx-auto"
                >
                    <span id="loadMoreText">Load More</span>
                    <div id="loadMoreSpinner" class="spinner hidden ml-3"></div>
                </button>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12 hidden">
                <div class="max-w-md mx-auto">
                    <div class="w-24 h-24 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class="fas fa-image text-3xl text-blue-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-800 mb-3">No Reviews Yet</h3>
                    <p class="text-gray-600 mb-6">Be the first to share your experience! Your review will appear here.</p>
                    <button onclick="document.getElementById('reviewForm').scrollIntoView({behavior: 'smooth'})" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300">
                        Share Your Experience
                    </button>
                </div>
            </div>
            
            <!-- Add Your Review Section -->
            <div class="mt-16 pt-12 border-t border-gray-200" id="reviewFormSection">
                <div class="text-center mb-12">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-4">Share Your Experience</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">Add your own review to be featured in our community gallery. Upload your photo, share your thoughts, and connect your social profile.</p>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <!-- Left Column: Form -->
                    <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
                        <h3 class="text-xl font-bold mb-6 text-gray-800">Submit Your Review</h3>
                        
                        <form id="reviewForm" class="space-y-6">
                            <!-- Profile Picture Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Profile Picture *
                                </label>
                                <div class="flex items-center justify-center w-full">
                                    <label for="profilePicture" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                                            <p class="mb-2 text-sm text-gray-500">
                                                <span class="font-semibold">Click to upload</span> or drag and drop
                                            </p>
                                            <p class="text-xs text-gray-500">PNG, JPG or GIF (MAX. 2MB)</p>
                                        </div>
                                        <input id="profilePicture" name="profilePicture" type="file" class="hidden" accept="image/*" required />
                                    </label>
                                </div>
                                <div id="profilePreview" class="mt-4 hidden">
                                    <p class="text-sm text-gray-600 mb-2">Preview:</p>
                                    <img id="profilePreviewImg" class="w-20 h-20 rounded-full border-2 border-gray-200 object-cover" />
                                </div>
                            </div>
                            
                            <!-- Main Image Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Your Photo/Image *
                                </label>
                                <div class="flex items-center justify-center w-full">
                                    <label for="mainImage" class="flex flex-col items-center justify-center w-full h-64 border-2 border-dashed border-gray-300 rounded-2xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
                                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                            <i class="fas fa-image text-4xl text-gray-400 mb-4"></i>
                                            <p class="mb-2 text-sm text-gray-500">
                                                <span class="font-semibold">Upload your photo</span>
                                            </p>
                                            <p class="text-xs text-gray-500">Show us your experience (MAX. 5MB)</p>
                                        </div>
                                        <input id="mainImage" name="mainImage" type="file" class="hidden" accept="image/*" required />
                                    </label>
                                </div>
                                <div id="mainImagePreview" class="mt-4 hidden">
                                    <p class="text-sm text-gray-600 mb-2">Preview:</p>
                                    <img id="mainImagePreviewImg" class="w-40 h-40 rounded-xl border-2 border-gray-200 object-cover" />
                                </div>
                            </div>
                            
                            <!-- Username -->
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                    Username *
                                </label>
                                <input
                                    type="text"
                                    id="username"
                                    name="username"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Your display name"
                                    required
                                />
                            </div>
                            
                            <!-- Platform Link -->
                            <div>
                                <label for="platformLink" class="block text-sm font-medium text-gray-700 mb-2">
                                    Social Media Profile
                                </label>
                                <div class="relative">
                                    <select id="platformSelect" class="absolute left-0 top-0 h-full w-32 px-3 border border-r-0 border-gray-300 rounded-l-xl bg-gray-50 focus:outline-none">
                                        <option value="instagram">Instagram</option>
                                        <option value="twitter">Twitter</option>
                                        <option value="telegram">Telegram</option>
                                        <option value="facebook">Facebook</option>
                                        <option value="linkedin">LinkedIn</option>
                                        <option value="github">GitHub</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <input
                                        type="text"
                                        id="platformLink"
                                        name="platformLink"
                                        class="w-full pl-36 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="username (without @)"
                                    />
                                </div>
                                <p class="text-xs text-gray-500 mt-2">Connect your social profile (optional)</p>
                            </div>
                            
                            <!-- Message -->
                            <div>
                                <label for="message" class="block text-sm font-medium text-gray-700 mb-2">
                                    Your Review/Message *
                                </label>
                                <textarea
                                    id="message"
                                    name="message"
                                    rows="4"
                                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Share your experience or feedback..."
                                    required
                                ></textarea>
                            </div>
                            
                            <!-- Security Key -->
                            <div>
                                <label for="securityKey" class="block text-sm font-medium text-gray-700 mb-2">
                                    Security Key *
                                    <span class="text-xs text-gray-500 ml-2">(Required for future modifications)</span>
                                </label>
                                <div class="relative">
                                    <input
                                        type="password"
                                        id="securityKey"
                                        name="securityKey"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Create a secure key (min. 6 characters)"
                                        minlength="6"
                                        required
                                    />
                                    <button type="button" onclick="toggleSecurityKey()" class="absolute right-3 top-3 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">
                                    Keep this key safe! You'll need it to edit or delete your review in the future.
                                </p>
                            </div>
                            
                            <!-- Terms -->
                            <div class="flex items-start">
                                <input
                                    id="terms"
                                    name="terms"
                                    type="checkbox"
                                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1"
                                    required
                                />
                                <label for="terms" class="ml-2 block text-sm text-gray-700">
                                    I agree to the <a href="#" class="text-blue-600 hover:text-blue-800">Terms of Service</a> and confirm that I have the rights to share these images.
                                </label>
                            </div>
                            
                            <!-- Submit Button -->
                            <div>
                                <button
                                    type="submit"
                                    id="submitButton"
                                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-blue-700 hover:to-purple-700 transition-all duration-300 transform hover:-translate-y-1 shadow-lg hover:shadow-xl flex items-center justify-center"
                                >
                                    <span id="submitText">Submit Review</span>
                                    <div id="submitSpinner" class="spinner hidden ml-3"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Right Column: Preview & Instructions -->
                    <div class="space-y-8">
                        <!-- Preview Card -->
                        <div class="bg-white rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-gray-800">Preview Your Review</h3>
                            <p class="text-gray-600 mb-6 text-sm">How your review will appear in the gallery:</p>
                            
                            <div id="previewCard" class="relative rounded-2xl overflow-hidden border-2 border-dashed border-gray-300">
                                <div class="bg-gray-100 h-48 rounded-t-2xl flex items-center justify-center">
                                    <p class="text-gray-400 text-sm">Your uploaded image will appear here</p>
                                </div>
                                <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/20 to-transparent opacity-50"></div>
                                <div class="absolute top-4 left-4 text-white">
                                    <div class="flex items-center gap-3 mb-2">
                                        <div class="w-8 h-8 rounded-full border-2 border-white/80 bg-gray-300 flex items-center justify-center">
                                            <span class="text-xs text-gray-600">ðŸ‘¤</span>
                                        </div>
                                        <span class="font-semibold text-sm drop-shadow-md" id="previewUsername">Your Username</span>
                                    </div>
                                    <p class="text-sm font-medium leading-tight drop-shadow-md" id="previewMessage">Your review message will appear here</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 p-4 bg-blue-50 rounded-xl">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-info-circle text-blue-400 mt-0.5"></i>
                                    </div>
                                    <div class="ml-3">
                                        <p class="text-sm text-blue-700">
                                            <strong>Note:</strong> Your review will be publicly visible. The security key is stored encrypted and can't be recovered if lost.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Edit Feature Info Card -->
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-100 rounded-2xl p-6 shadow-lg">
                            <h3 class="text-xl font-bold mb-4 text-blue-800"><i class="fas fa-pencil-alt mr-2"></i> Edit Feature</h3>
                            <p class="text-blue-700 mb-4">
                                <strong>Hover over any image in the gallery to see the edit pencil icon.</strong> Click the pencil to modify that post.
                            </p>
                            <ul class="space-y-3 text-sm text-blue-600">
                                <li class="flex items-start">
                                    <i class="fas fa-mouse-pointer text-blue-500 mr-2 mt-0.5"></i>
                                    <span>Hover over any image to reveal the edit pencil</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-pencil-alt text-blue-500 mr-2 mt-0.5"></i>
                                    <span>Click the pencil icon to edit that specific post</span>
                                </li>
                                <li class="flex items-start">
                                    <i class="fas fa-lock text-blue-500 mr-2 mt-0.5"></i>
                                    <span>You'll need your security key to edit any posts</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4">
        <div class="relative max-w-4xl w-full max-h-[90vh]">
            <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white bg-black/50 rounded-full p-2 z-10 hover:bg-black/70">
                <i class="fas fa-times text-xl"></i>
            </button>
            <img id="modalImage" class="w-full h-auto max-h-[80vh] object-contain rounded-lg">
            <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-6">
                <p id="modalCaption" class="text-white text-lg font-medium"></p>
                <p id="modalAuthor" class="text-gray-300 text-sm mt-1"></p>
                <p id="modalDate" class="text-gray-400 text-xs mt-2"></p>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full">
            <h3 class="text-xl font-bold mb-4 text-gray-800">Edit Post</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Enter Security Key
                    </label>
                    <input
                        type="password"
                        id="editSecurityKey"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter your security key"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        New Caption
                    </label>
                    <input
                        type="text"
                        id="editCaption"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Enter new caption"
                    />
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeEditModal()" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50">
                    Cancel
                </button>
                <button onclick="saveEdit()" class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE_URL = 'https://review-api.vercel.app/api';
        
        // Global variables
        let currentPostId = null;
        let currentPage = 1;
        let isLoading = false;
        let hasMore = false;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            adjustColumns();
            loadReviews(1);
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Platform select change
            document.getElementById('platformSelect').addEventListener('change', function(e) {
                const platformLink = document.getElementById('platformLink');
                if (e.target.value === 'other') {
                    platformLink.placeholder = 'Enter full profile URL';
                } else {
                    platformLink.placeholder = 'username (without @)';
                }
            });
            
            // Real-time preview updates
            document.getElementById('username').addEventListener('input', function(e) {
                document.getElementById('previewUsername').textContent = e.target.value || 'Your Username';
            });
            
            document.getElementById('message').addEventListener('input', function(e) {
                document.getElementById('previewMessage').textContent = e.target.value || 'Your review message will appear here';
            });
            
            // Image previews
            setupImagePreview('profilePicture', 'profilePreviewImg', 'profilePreview', 2);
            setupImagePreview('mainImage', 'mainImagePreviewImg', 'mainImagePreview', 5);
            
            // Form submission
            document.getElementById('reviewForm').addEventListener('submit', submitReview);
            
            // Modal close events
            document.getElementById('imageModal').addEventListener('click', function(e) {
                if (e.target === this) closeImageModal();
            });
            
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                    closeEditModal();
                }
            });
            
            // Window resize
            window.addEventListener('resize', adjustColumns);
        }
        
        // Setup image preview with validation
        function setupImagePreview(inputId, previewImgId, previewContainerId, maxSizeMB) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size
                    if (file.size > maxSizeMB * 1024 * 1024) {
                        showToast(`File must be less than ${maxSizeMB}MB`, 'error');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewImg = document.getElementById(previewImgId);
                        previewImg.src = e.target.result;
                        document.getElementById(previewContainerId).classList.remove('hidden');
                        
                        // Update preview card if it's the main image
                        if (inputId === 'mainImage') {
                            const previewCard = document.getElementById('previewCard');
                            const placeholder = previewCard.querySelector('.bg-gray-100');
                            if (placeholder) {
                                placeholder.innerHTML = `<img src="${e.target.result}" class="w-full h-48 object-cover rounded-t-2xl" />`;
                            }
                        }
                    }
                    reader.readAsDataURL(file);
                }
            });
        }
        
        // Adjust masonry columns based on screen size
        function adjustColumns() {
            const grid = document.getElementById('masonry-grid');
            if (!grid) return;
            
            const width = window.innerWidth;
            if (width < 640) {
                grid.style.columnCount = 1;
            } else if (width < 1024) {
                grid.style.columnCount = 2;
            } else if (width < 1280) {
                grid.style.columnCount = 3;
            } else {
                grid.style.columnCount = 4;
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                info: 'info-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${icons[type]} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease-out reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Load reviews from API
        async function loadReviews(page = 1) {
            if (isLoading) return;
            
            isLoading = true;
            const grid = document.getElementById('masonry-grid');
            
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            try {
                const res = await fetch(`${API_BASE_URL}/review/list?page=${page}&limit=12`);
                const data = await res.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Failed to load reviews');
                }
                
                // Hide loading indicator
                document.getElementById('loadingIndicator').classList.add('hidden');
                
                // Clear grid for first page
                if (page === 1) {
                    grid.innerHTML = '';
                    updateTotalCount(data.total);
                }
                
                // Show empty state if no reviews
                if (data.reviews.length === 0 && page === 1) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }
                
                // Render each review
                data.reviews.forEach((review, index) => {
                    const card = createReviewCard(review, (page - 1) * 12 + index);
                    grid.appendChild(card);
                });
                
                // Update pagination state
                currentPage = page;
                hasMore = data.has_more;
                
                // Show/hide load more button
                const loadMoreContainer = document.getElementById('loadMoreContainer');
                if (hasMore) {
                    loadMoreContainer.classList.remove('hidden');
                } else {
                    loadMoreContainer.classList.add('hidden');
                }
                
            } catch (error) {
                console.error('Error loading reviews:', error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-3xl text-yellow-500 mb-3"></i>
                        <p class="text-gray-600 mb-4">Failed to load reviews</p>
                        <button onclick="loadReviews(1)" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Try Again
                        </button>
                    </div>
                `;
            } finally {
                isLoading = false;
                document.getElementById('loadMoreSpinner').classList.add('hidden');
                document.getElementById('loadMoreText').textContent = 'Load More';
                adjustColumns();
            }
        }
        
        // Load more reviews
        function loadMoreReviews() {
            if (!isLoading && hasMore) {
                loadReviews(currentPage + 1);
            }
        }
        
        // Update total review count
        function updateTotalCount(total) {
            document.getElementById('totalReviews').textContent = total;
        }
        
        // Create a review card element
        function createReviewCard(review, index) {
            const div = document.createElement('div');
            div.className = `masonry-item animate-fade-in-up`;
            div.style.animationDelay = `${(index % 8) * 0.1 + 0.1}s`;
            div.dataset.reviewId = review._id;
            
            // Format date
            const date = new Date(review.created_at);
            const formattedDate = date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            // Escape quotes for onclick
            const safeMessage = review.message.replace(/'/g, "\\'");
            const safeName = review.user.display_name.replace(/'/g, "\\'");
            
            div.innerHTML = `
                <div class="edit-icon" onclick="editPost('${review._id}')">
                    <i class="fas fa-pencil-alt text-gray-700"></i>
                </div>
                <div class="relative rounded-2xl overflow-hidden group card-hover">
                    <img
                        src="${review.images.main}"
                        alt="${review.message}"
                        class="w-full h-auto object-cover cursor-pointer"
                        onclick="openImageModal(
                            '${review.images.main}',
                            '${safeMessage}',
                            '${safeName}',
                            '${formattedDate}'
                        )"
                        onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1506905925346-21bda4d32df4?auto=format&fit=crop&w=800&q=80'"
                    />
                    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/20 to-transparent"></div>
                    <div class="absolute top-0 left-0 p-4 text-white">
                        <div class="flex items-center gap-3 mb-2">
                            <img
                                src="${review.images.pfp}"
                                class="w-8 h-8 rounded-full border-2 border-white/80"
                                alt="${review.user.display_name}"
                                onerror="this.onerror=null; this.src='https://randomuser.me/api/portraits/men/32.jpg'"
                            />
                            <div>
                                <span class="font-semibold text-sm drop-shadow-md">${review.user.display_name}</span>
                                ${review.user.platform_username ? `
                                    <div class="flex items-center gap-1 mt-0.5">
                                        <i class="fab fa-${getPlatformIcon(review.user.platform)} text-xs"></i>
                                        <span class="text-xs opacity-90">@${review.user.platform_username}</span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <p class="text-sm font-medium leading-tight drop-shadow-md">${review.message}</p>
                    </div>
                    <div class="absolute bottom-0 left-0 right-0 p-4 text-white/90">
                        <div class="flex justify-between items-center">
                            <span class="text-xs opacity-80">${formattedDate}</span>
                            <i class="fas fa-heart text-xs"></i>
                        </div>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Get platform icon - UPDATED to include Telegram
        function getPlatformIcon(platform) {
            const icons = {
                'instagram': 'instagram',
                'twitter': 'twitter',
                'telegram': 'telegram',
                'facebook': 'facebook-f',
                'linkedin': 'linkedin',
                'github': 'github'
            };
            return icons[platform] || 'globe';
        }
        
        // Toggle security key visibility
        function toggleSecurityKey() {
            const securityKey = document.getElementById('securityKey');
            const type = securityKey.getAttribute('type');
            securityKey.setAttribute('type', type === 'password' ? 'text' : 'password');
        }
        
        // Submit review form
        async function submitReview(e) {
            e.preventDefault();
            
            const submitButton = document.getElementById('submitButton');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Show loading state
            submitButton.disabled = true;
            submitText.textContent = 'Submitting...';
            submitSpinner.classList.remove('hidden');
            
            try {
                // Prepare FormData
                const formData = new FormData();
                
                const payload = {
                    user: {
                        display_name: document.getElementById('username').value,
                        platform: document.getElementById('platformSelect').value,
                        platform_username: document.getElementById('platformLink').value || ''
                    },
                    security_key: document.getElementById('securityKey').value,
                    message: document.getElementById('message').value
                };
                
                formData.append("data", JSON.stringify(payload));
                formData.append("pfp", document.getElementById('profilePicture').files[0]);
                formData.append("main_image", document.getElementById('mainImage').files[0]);
                
                // Submit to API
                const res = await fetch(`${API_BASE_URL}/review/submit`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast("Review submitted successfully!", 'success');
                    console.log("Review ID:", data.review_id);
                    
                    // Reset form
                    resetForm();
                    
                    // Reload reviews after a short delay
                    setTimeout(() => {
                        loadReviews(1);
                    }, 1000);
                    
                } else {
                    throw new Error(data.message || 'Submission failed');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showToast('Failed to submit review: ' + error.message, 'error');
            } finally {
                // Reset button state
                submitButton.disabled = false;
                submitText.textContent = 'Submit Review';
                submitSpinner.classList.add('hidden');
            }
        }
        
        // Reset form
        function resetForm() {
            document.getElementById('reviewForm').reset();
            document.getElementById('profilePreview').classList.add('hidden');
            document.getElementById('mainImagePreview').classList.add('hidden');
            document.getElementById('previewUsername').textContent = 'Your Username';
            document.getElementById('previewMessage').textContent = 'Your review message will appear here';
            
            // Reset preview card image
            const previewCard = document.getElementById('previewCard');
            const placeholder = previewCard.querySelector('.bg-gray-100');
            if (placeholder) {
                placeholder.innerHTML = '<p class="text-gray-400 text-sm">Your uploaded image will appear here</p>';
            }
        }
        
        // Open image modal
        function openImageModal(imageSrc, caption, author, date) {
            document.getElementById('modalImage').src = imageSrc;
            document.getElementById('modalCaption').textContent = caption;
            document.getElementById('modalAuthor').textContent = author ? `by ${author}` : '';
            document.getElementById('modalDate').textContent = date || '';
            document.getElementById('imageModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
        }
        
        // Edit post functionality
        function editPost(postId) {
            currentPostId = postId;
            const reviewElement = document.querySelector(`[data-review-id="${postId}"]`);
            if (reviewElement) {
                const caption = reviewElement.querySelector('p.text-sm.font-medium').textContent;
                document.getElementById('editCaption').value = caption || '';
            }
            document.getElementById('editModal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.body.style.overflow = 'auto';
            currentPostId = null;
            document.getElementById('editSecurityKey').value = '';
            document.getElementById('editCaption').value = '';
        }
        
        async function saveEdit() {
            const securityKey = document.getElementById('editSecurityKey').value;
            const newCaption = document.getElementById('editCaption').value;
            
            if (!securityKey) {
                showToast('Please enter your security key', 'error');
                return;
            }
            
            if (!newCaption.trim()) {
                showToast('Please enter a new caption', 'error');
                return;
            }
            
            try {
                const formData = new FormData();
                const payload = {
                    review_id: currentPostId,
                    security_key: securityKey,
                    message: newCaption
                };
                
                formData.append("data", JSON.stringify(payload));
                
                const res = await fetch(`${API_BASE_URL}/review/update`, {
                    method: "POST",
                    body: formData
                });
                
                const data = await res.json();
                
                if (data.success) {
                    showToast('Post updated successfully!', 'success');
                    closeEditModal();
                    setTimeout(() => {
                        loadReviews(currentPage);
                    }, 500);
                } else {
                    throw new Error(data.message || 'Update failed');
                }
            } catch (error) {
                showToast('Failed to update post: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
